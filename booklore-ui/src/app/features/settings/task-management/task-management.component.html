<div class="main-container enclosing-container">
  <div class="settings-header">
    <h2 class="settings-title">
      <i class="pi pi-list-check"></i>
      System Task Manager
      <app-external-doc-link docType="taskManagement"></app-external-doc-link>
    </h2>
    <p class="settings-description">
      Monitor and manage system tasks including cache operations, library scanning, and other background processes.
    </p>
  </div>

  <div class="settings-content">
    <div class="preferences-section">
      <div class="section-header">
        <div class="section-header-content">
          <h3 class="section-title">
            <i class="pi pi-cog"></i>
            One-Time Tasks
          </h3>
          <p-button
            label="Refresh"
            icon="pi pi-refresh"
            size="small"
            outlined
            [loading]="loading"
            (onClick)="loadTasks()">
          </p-button>
        </div>
      </div>

      @if (loading && tasks.length === 0) {
        <div class="loading-container">
          <i class="pi pi-spin pi-spinner"></i>
          <span>Loading tasks...</span>
        </div>
      }

      @for (task of tasks; track task.type) {
        @if (task.type === TaskType.CLEAR_CBX_CACHE || task.type === TaskType.CLEAR_PDF_CACHE) {
          <div class="settings-card" [class.compact]="!isTaskRunning(task)">
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label-row">
                  <div class="task-title-section">
                    <div class="title-with-status">
                      <label class="setting-label">
                        <i class="pi pi-trash"></i>
                        {{ getTaskDisplayName(task.type) }}
                      </label>
                      @if (!isTaskRunning(task) && task.id) {
                        <span class="last-run-badge">[{{ getLastRunMessage(task) }}<span class="sep">|</span><span class="status-dot" [ngClass]="getLastRunInfoClass(task.status)"></span><span
                          class="status-text">{{ getLastRunInfoClass(task.status) === 'success' ? 'Success' : getLastRunInfoClass(task.status) === 'error' ? 'Error' : getLastRunInfoClass(task.status) === 'warning' ? 'Warning' : 'Info' }}]</span></span>
                      }
                    </div>
                    @if (!isTaskRunning(task)) {
                      <p class="setting-description compact">
                        {{ getTaskDescription(task.type) }}
                      </p>
                    }
                    @if (!isTaskRunning(task) && hasMetadata(task)) {
                      <div class="task-metadata prominent">
                        @if (task.metadata.currentCacheSize) {
                          <span class="metadata-item prominent">
                            <i class="pi pi-database"></i>
                            Current cache size:
                            <span class="cache-size-value">{{ task.metadata.currentCacheSize }}</span>
                          </span>
                        }
                      </div>
                    }
                  </div>
                  <div class="task-actions">
                    @if (isTaskRunning(task) && !isTaskStale(task)) {
                      <p-badge
                        value="In Progress"
                        severity="info">
                      </p-badge>
                    }
                    @if (isTaskStale(task)) {
                      <p-badge
                        value="Stale"
                        severity="warn">
                      </p-badge>
                    }
                    @if (canExecuteTask(task) || isTaskStale(task)) {
                      <p-button
                        label="Clear Cache"
                        icon="pi pi-trash"
                        size="small"
                        severity="warn"
                        (onClick)="executeTask(task)">
                      </p-button>
                    }
                    @if (canCancelTask(task) && !isTaskStale(task)) {
                      <p-button
                        label="Cancel"
                        icon="pi pi-times"
                        size="small"
                        severity="danger"
                        outlined
                        (onClick)="cancelTask(task)">
                      </p-button>
                    }
                  </div>
                </div>

                @if (isTaskRunning(task)) {
                  <div class="task-details" [class.stale]="isTaskStale(task)">
                    @if (isTaskStale(task)) {
                      <div class="task-info-row stale-warning">
                        <span class="task-info-label">
                          <i class="pi pi-exclamation-triangle"></i>
                          Warning:
                        </span>
                        <span class="task-info-value warning-text">
                          This task appears to be stuck. No updates received for over 10 minutes.
                        </span>
                      </div>
                    }
                    @if (task.message || isTaskStale(task)) {
                      <div class="task-info-row">
                        <span class="task-info-label">Status:</span>
                        <span class="task-info-value">{{ getTaskStatusMessage(task) }}</span>
                      </div>
                    }
                    @if (task.progressPercentage !== null) {
                      <div class="task-info-row">
                        <span class="task-info-label">Progress:</span>
                        <div class="progress-container">
                          <p-progressbar [value]="task.progressPercentage"></p-progressbar>
                          <span class="progress-text">{{ task.progressPercentage }}%</span>
                        </div>
                      </div>
                    }
                    @if (task.updatedAt) {
                      <div class="task-info-row">
                        <span class="task-info-label">Started:</span>
                        <span class="task-info-value">{{ formatDate(task.updatedAt) }}</span>
                      </div>
                    }
                  </div>

                  <p class="setting-description expanded">
                    <i class="pi pi-info-circle"></i>
                    {{ getTaskDescription(task.type) }}
                  </p>
                }
              </div>
            </div>
          </div>
        }

        @if (task.type === TaskType.RE_SCAN_LIBRARY) {
          <div class="settings-card" [class.compact]="!isTaskRunning(task)">
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label-row">
                  <div class="task-title-section">
                    <div class="title-with-status">
                      <label class="setting-label">
                        <i class="pi pi-sync"></i>
                        {{ getTaskDisplayName(task.type) }}
                      </label>
                      @if (!isTaskRunning(task) && task.id) {
                        <span class="last-run-badge">[{{ getLastRunMessage(task) }}<span class="sep">|</span><span class="status-dot" [ngClass]="getLastRunInfoClass(task.status)"></span><span
                          class="status-text">{{ getLastRunInfoClass(task.status) === 'success' ? 'Success' : getLastRunInfoClass(task.status) === 'error' ? 'Error' : getLastRunInfoClass(task.status) === 'warning' ? 'Warning' : 'Info' }}]</span></span>
                      }
                    </div>
                    <p class="setting-description compact always-visible">
                      {{ getTaskDescription(task.type) }}
                    </p>
                    @if (!isTaskRunning(task)) {
                      <div class="task-options">
                        <div class="option-group">
                          <label class="option-label">Metadata Replace Mode:</label>
                          <p-select
                            [options]="metadataReplaceOptions"
                            [(ngModel)]="selectedMetadataReplaceMode"
                            placeholder="Select mode"
                            class="metadata-select">
                          </p-select>
                          <p class="option-description">
                            {{ getMetadataReplaceDescription(selectedMetadataReplaceMode) }}
                          </p>
                        </div>
                      </div>
                    }
                  </div>
                  <div class="task-actions">
                    @if (isTaskRunning(task) && !isTaskStale(task)) {
                      <p-badge
                        value="In Progress"
                        severity="info">
                      </p-badge>
                    }
                    @if (isTaskStale(task)) {
                      <p-badge
                        value="Stale"
                        severity="warn">
                      </p-badge>
                    }
                    @if (canExecuteTask(task) || isTaskStale(task)) {
                      <p-button
                        label="Start Refresh"
                        icon="pi pi-sync"
                        size="small"
                        severity="success"
                        (onClick)="executeTask(task)">
                      </p-button>
                    }
                    @if (canCancelTask(task) && !isTaskStale(task)) {
                      <p-button
                        label="Cancel"
                        icon="pi pi-times"
                        size="small"
                        severity="danger"
                        outlined
                        (onClick)="cancelTask(task)">
                      </p-button>
                    }
                  </div>
                </div>
                @if (isTaskRunning(task)) {
                  <div class="task-details" [class.stale]="isTaskStale(task)">
                    @if (isTaskStale(task)) {
                      <div class="task-info-row stale-warning">
                        <span class="task-info-label">
                          <i class="pi pi-exclamation-triangle"></i>
                          Warning:
                        </span>
                        <span class="task-info-value warning-text">
                          This task appears to be stuck. No updates received for over 10 minutes.
                        </span>
                      </div>
                    }
                    @if (task.message || isTaskStale(task)) {
                      <div class="task-info-row">
                        <span class="task-info-label">Status:</span>
                        <span class="task-info-value">{{ getTaskStatusMessage(task) }}</span>
                      </div>
                    }
                    @if (task.progressPercentage !== null) {
                      <div class="task-info-row">
                        <span class="task-info-label">Progress:</span>
                        <div class="progress-container">
                          <p-progressbar [value]="task.progressPercentage"></p-progressbar>
                          <span class="progress-text">{{ task.progressPercentage }}%</span>
                        </div>
                      </div>
                    }
                    @if (task.updatedAt) {
                      <div class="task-info-row">
                        <span class="task-info-label">Started:</span>
                        <span class="task-info-value">{{ formatDate(task.updatedAt) }}</span>
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          </div>
        }
      }

      @if (!loading && tasks.length === 0) {
        <div class="settings-card">
          <div class="setting-item">
            <div class="setting-info">
              <div class="no-tasks-message">
                <i class="pi pi-check-circle"></i>
                <span>No tasks available</span>
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
</div>
